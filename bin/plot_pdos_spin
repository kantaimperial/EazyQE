#!/usr/bin/env python3
import os, re, argparse, glob
import numpy as np
import matplotlib.pyplot as plt
from collections import defaultdict

#--- args ---
p = argparse.ArgumentParser(description="Plot spin-resolved PDOS (atom/orbital filter)")
p.add_argument("--EFermi", type=float, default=None, help="0 ã‚·ãƒ•ãƒˆã™ã‚‹ãƒ•ã‚§ãƒ«ãƒŸæº–ä½ (eV)")
p.add_argument("--atoms", type=str, default=None,
               help="ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šå…ƒç´ æŒ‡å®š (ä¾‹: Bi,Co1,Co2)ã€‚æœªæŒ‡å®šã§å…¨å…ƒç´ ")
p.add_argument("--orbital", type=str, default=None,
               help="åˆ†è§£æç”»ã™ã‚‹è»Œé“æŒ‡å®š Atom.orb (ä¾‹: Co1.d)")
p.add_argument("--xmin", type=float, default=-6.0)
p.add_argument("--xmax", type=float, default=6.0)
p.add_argument("--ymax", type=float, default=None)
p.add_argument("--lloc", type=str, default="upper right")
p.add_argument("--lloc_x", type=float, default=1.5)
p.add_argument("--lloc_y", type=float, default=1.0)
p.add_argument("--no-total", action="store_true")
args = p.parse_args()

#--- EFermi è‡ªå‹•å–å¾— ---
if args.EFermi is None:
    for fn in ("get_gap.out","./get_gap.out"):
        if os.path.exists(fn):
            with open(fn) as f:
                for L in f:
                    if L.startswith("VBM:"):
                        args.EFermi = float(L.split()[1])
                        print(f"ğŸ“¥ EFermi = {args.EFermi} eV (from {fn})")
                        break
            break
if args.EFermi is None:
    raise RuntimeError("EFermi ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚--EFermi ã¾ãŸã¯ get_gap.out ã‚’ç”¨ã„ã¦ãã ã•ã„ã€‚")

#--- ãƒ•ã‚£ãƒ«ã‚¿è¨­å®š ---
atoms_filter = args.atoms.split(",") if args.atoms else None
orb_atom, orb_type = None, None
if args.orbital:
    if "." not in args.orbital:
        raise ValueError("--orbital ã¯ AtomName.orbital ã®å½¢å¼")
    orb_atom, orb_type = args.orbital.split(".",1)

#--- è»Œé“ãƒ©ãƒ™ãƒ« ---
orb_labels = {
    "d": ["dz2","dzx","dzy","dx2-y2","dxy"],
    "p": ["pz","px","py"],
}

#--- ãƒ•ã‚¡ã‚¤ãƒ«åé›† ---
pdos_files = [f for f in os.listdir(".") if re.search(r"pdos_atm#\d+\(",f)]
if not pdos_files:
    print("âš ï¸ pdos_atm ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
file_map = defaultdict(list)

# --- ãƒ•ã‚¡ã‚¤ãƒ«åˆ†é¡ ---
pat = re.compile(r"atm#\d+\(([^)]+)\)_wfc#\d+\((\w+)\)")
for f in pdos_files:
    m = pat.search(f)
    if not m:
        continue
    full = m.group(1)
    orb  = m.group(2)
    m2 = re.match(r"([A-Za-z]+)(\d+)$", full)
    atom = full if not m2 else f"{m2.group(1)}{m2.group(2)}"
    key = f"{atom}-{orb}"
    file_map[key].append(f)

print("ğŸ” è¦‹ã¤ã‹ã£ãŸ pdos_atm keys:")
for k in sorted(file_map): print("   ", k)

#--- èª­ã¿è¾¼ã¿ ---
def read_basic(fn, shift):
    E, UP, DW = [],[],[]
    with open(fn) as f:
        for L in f:
            if L.strip().startswith("#"): continue
            parts=L.split()
            if len(parts)<3: continue
            e = float(parts[0]) - shift
            UP.append(float(parts[1].replace("D","E")))
            DW.append(float(parts[2].replace("D","E")))
            E.append(e)
    return np.array(E), np.array(UP), np.array(DW)

def read_decomp(fn, shift, orb):
    labels = orb_labels.get(orb)
    n = len(labels)
    UPs=[[] for _ in range(n)]; DWs=[[] for _ in range(n)]; E=[]
    with open(fn) as f:
        for L in f:
            if L.strip().startswith("#"): continue
            parts=L.split()
            if len(parts) < 3+2*n: continue
            e=float(parts[0])-shift; E.append(e)
            base=3
            for i in range(n):
                UPs[i].append(float(parts[base+2*i].replace("D","E")))
                DWs[i].append(float(parts[base+2*i+1].replace("D","E")))
    return np.array(E), [np.array(u) for u in UPs], [np.array(d) for d in DWs]

#--- plot ---
plt.figure(figsize=(7,4))
colors = plt.cm.tab10.colors
idx=0; plotted=False

for key, flist in sorted(file_map.items()):
    atom, orb = key.split("-")
    if atoms_filter and atom not in atoms_filter: continue
    decomp = (atom==orb_atom and orb==orb_type)
    if args.orbital and not decomp: continue

    if decomp:
        fn=flist[0]
        E, UPs, DWs = read_decomp(fn, args.EFermi, orb_type)
        for i,label in enumerate(orb_labels[orb_type]):
            c=colors[idx%10]
            plt.plot(E, UPs[i],  color=c, lw=1.2, label=f"{atom}.{label} â†‘")
            plt.fill_between(E, 0, UPs[i], color=c, alpha=0.3)
            plt.plot(E, -DWs[i], color=c, lw=1.2)
            plt.fill_between(E, 0, -DWs[i], color=c, alpha=0.3)
            idx+=1; plotted=True
    else:
        E0, U0, D0 = None, None, None
        for fn in flist:
            E, UP, DW = read_basic(fn, args.EFermi)
            if E0 is None:
                E0,U0,D0 = E.copy(), UP.copy(), DW.copy()
            else:
                U0+=UP; D0+=DW
        c=colors[idx%10]
        plt.plot(E0, U0,  color=c, lw=1.2, label=f"{atom}-{orb} â†‘")
        plt.fill_between(E0, 0, U0, color=c, alpha=0.3)
        plt.plot(E0,-D0,  color=c, lw=1.2)
        plt.fill_between(E0, 0, -D0, color=c, alpha=0.3)
        idx+=1; plotted=True

#--- total ---
if not args.no_total:
    tots = [f for f in os.listdir(".") if f.endswith(".pdos_tot")]
    if tots:
        E_t, U_t, D_t = read_basic(tots[0], args.EFermi)
        plt.plot(E_t, U_t,  color="gray", lw=1.2, label="Total â†‘")
        plt.fill_between(E_t, 0, U_t, color="gray", alpha=0.3)
        plt.plot(E_t,-D_t,  color="gray", lw=1.2)
        plt.fill_between(E_t, 0, -D_t, color="gray", alpha=0.3)
        plotted=True

#--- finalize ---
if not plotted:
    print("âš ï¸ å®Ÿéš›ã«ãƒ—ãƒ­ãƒƒãƒˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    exit(1)

plt.axvline(0, color="gray", ls="--")
plt.axhline(0, color="black", lw=0.5)
plt.xlim(args.xmin, args.xmax)
if args.ymax: plt.ylim(-args.ymax, args.ymax)
plt.xlabel("Energy (eV)"); plt.ylabel("DOS (states/eV)")
plt.title("Spin-polarized PDOS")
# --- å‡¡ä¾‹ã®è¡¨ç¤º ---
if args.lloc_x is not None and args.lloc_y is not None:
    # åº§æ¨™æŒ‡å®šãŒã‚ã‚Œã°å¸¸ã« bbox_to_anchor ã§è¡¨ç¤ºï¼ˆmanualä»¥å¤–ã§ã‚‚æœ‰åŠ¹ï¼‰
    plt.legend(fontsize=10, loc=args.lloc, bbox_to_anchor=(args.lloc_x, args.lloc_y))
else:
    # é€šå¸¸ã® loc æŒ‡å®šï¼ˆæ–‡å­—åˆ—: 'best', 'upper right' ãªã©ï¼‰
    plt.legend(fontsize=10, loc=args.lloc)

plt.tight_layout()
plt.savefig("pdos.pdf")
print("âœ… pdos.pdf saved")

